<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Ricetta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <h1>Il Mio <span>Ricettario</span></h1>
    </header>

    <div class="container">
        <div class="nav-back">
            <a href="index.html" class="btn-back">‚Üê Torna alle Ricette</a>
        </div>

        <div class="recipe-detail" id="contenuto-ricetta">
            <h2 style="text-align:center;">Caricamento ricetta...</h2>
        </div>
    </div>

    <div class="footer">
        &copy; 2025 Il Mio Ricettario
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ricettaId = params.get('id');

        fetch('ricette.json')
            .then(response => response.json())
            .then(data => {
                const ricetta = data.find(r => r.id === ricettaId);

                if (ricetta) {
                    document.title = ricetta.titolo;

                    // Ingredienti
                    let listaIngredienti = '';
                    ricetta.ingredienti.forEach(ing => {
                        listaIngredienti += `<li>${ing}</li>`;
                    });

                    // Passaggi
                    let listaPassaggi = '';
                    ricetta.passaggi.forEach(step => {
                        if (typeof step === 'string') {
                            listaPassaggi += `<li>${step}</li>`;
                        } else {
                            // Costruzione Contenuto Media
                            let mediaContent = '';

                            // Immagine
                            if (step.img && step.img.trim() !== "") {
                                mediaContent += `<img src="${step.img}" alt="Passaggio">`;
                            }

                            // Video
                            if (step.video && step.video.trim() !== "") {
                                mediaContent += generaHtmlVideo(step.video);
                            }

                            // Wrap nella griglia
                            let mediaHtml = '';
                            if (mediaContent !== '') {
                                mediaHtml = `<div class="step-media-grid">${mediaContent}</div>`;
                            }

                            listaPassaggi += `
                                <li>
                                    <p style="margin-bottom: 5px;">${step.testo}</p>
                                    ${mediaHtml}
                                </li>`;
                        }
                    });

                    // Tags
                    let tagsHtml = '';
                    if(ricetta.tags) {
                        ricetta.tags.forEach(tag => tagsHtml += `<span class="tag">${tag}</span>`);
                    }

                    const porzioni = ricetta.porzioni ? ricetta.porzioni : "Non specificato";

                    // Video Finale
                    let videoPrincipaleHtml = '';
                    if (ricetta.video) {
                        videoPrincipaleHtml = `
                            <div class="video-section" style="margin-top: 50px; border-top: 1px solid #eee; padding-top: 30px;">
                                <h3 class="video-title">Video Ricetta Completa</h3>
                                ${generaHtmlVideo(ricetta.video)}
                            </div>
                        `;
                    }

                    document.getElementById('contenuto-ricetta').innerHTML = `
                        <div style="margin-bottom:10px;">${tagsHtml}</div>
                        <h1>${ricetta.titolo}</h1>
                        
                        <p style="color:#666; margin-bottom: 20px; font-size: 0.95rem;">
                            <strong>‚è± Tempo:</strong> ${ricetta.tempo} &nbsp;|&nbsp; 
                            <strong>üë• Porzioni:</strong> ${porzioni} &nbsp;|&nbsp; 
                            <strong>üî• Difficolt√†:</strong> ${ricetta.difficolta}
                        </p>
                        
                        <img src="${ricetta.img}" class="main-img" style="margin-bottom: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        
                        <div class="ingredients" style="background:#fff8e1; padding:30px; border-radius:12px; margin-bottom:40px;">
                            <h2 style="margin-top:0; color:#c62828;">Ingredienti</h2>
                            <ul style="margin:0; padding-left:20px;">${listaIngredienti}</ul>
                        </div>

                        <div class="instructions">
                            <h2>Procedimento</h2>
                            <ol style="padding-left:20px; font-size:1.1rem;">${listaPassaggi}</ol>
                        </div>

                        ${videoPrincipaleHtml}
                    `;
                } else {
                    document.getElementById('contenuto-ricetta').innerHTML = `
                        <div style="text-align:center; padding:50px;">
                            <h2>Ops! Ricetta non trovata.</h2>
                            <a href="index.html" class="button" style="max-width:200px; margin:20px auto;">Torna alla Home</a>
                        </div>
                    `;
                }
            });

        // Funzione Generatore Video
        function generaHtmlVideo(urlVideo) {
            const videoId = estraiIdYouTube(urlVideo);
            
            if (videoId) {
                // YOUTUBE
                return `
                <div class="video-container">
                    <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                </div>`;
            } else {
                // VIDEO LOCALE
                return `
                <video controls class="local-video-player">
                    <source src="${urlVideo}" type="video/mp4">
                    Il tuo browser non supporta il video.
                </video>`;
            }
        }

        function estraiIdYouTube(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
    </script>
</body>
</html>