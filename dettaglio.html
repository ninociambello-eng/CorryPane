<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Ricetta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <h1>Il Mio <span>Ricettario</span></h1>
    </header>

    <div class="container">
        <div class="nav-back">
            <a href="index.html" class="btn-back">‚Üê Torna alle Ricette</a>
        </div>

        <div class="recipe-detail" id="contenuto-ricetta">
            <h2 style="text-align:center;">Caricamento ricetta...</h2>
        </div>
    </div>

    <div class="footer">
        &copy; 2025 Il Mio Ricettario
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ricettaId = params.get('id');

        fetch('ricette.json')
            .then(response => response.json())
            .then(data => {
                const ricetta = data.find(r => r.id === ricettaId);

                if (ricetta) {
                    document.title = ricetta.titolo;

                    // Gestione Ingredienti
                    let listaIngredienti = '';
                    ricetta.ingredienti.forEach(ing => {
                        listaIngredienti += `<li>${ing}</li>`;
                    });

                    // --- GESTIONE PASSAGGI ---
                    let listaPassaggi = '';
                    
                    ricetta.passaggi.forEach(step => {
                        if (typeof step === 'string') {
                            // Caso solo testo
                            listaPassaggi += `<li>${step}</li>`;
                        } else {
                            // Caso Oggetto (Testo + Img + Video)
                            let mediaHtml = '';

                            // Immagine Step
                            if (step.img && step.img.trim() !== "") {
                                mediaHtml += `<img src="${step.img}" class="step-img" alt="Passaggio">`;
                            }

                            // Video Step (Chiamiamo la funzione passando 'true' per dire che √® uno step)
                            if (step.video && step.video.trim() !== "") {
                                mediaHtml += generaHtmlVideo(step.video, true);
                            }

                            listaPassaggi += `
                                <li>
                                    <p style="margin-bottom: 5px;">${step.testo}</p>
                                    ${mediaHtml}
                                </li>`;
                        }
                    });

                    // Gestione Tag
                    let tagsHtml = '';
                    if(ricetta.tags) {
                        ricetta.tags.forEach(tag => tagsHtml += `<span class="tag">${tag}</span>`);
                    }

                    const porzioni = ricetta.porzioni ? ricetta.porzioni : "Non specificato";

                    // --- VIDEO PRINCIPALE (A fine pagina) ---
                    let videoPrincipaleHtml = '';
                    if (ricetta.video) {
                        // Qui passiamo 'false' perch√© √® il video principale grande
                        videoPrincipaleHtml = `
                            <div class="video-section" style="margin-top: 50px; border-top: 1px solid #eee; padding-top: 30px;">
                                <h3 class="video-title">Video Ricetta Completa</h3>
                                ${generaHtmlVideo(ricetta.video, false)}
                            </div>
                        `;
                    }

                    document.getElementById('contenuto-ricetta').innerHTML = `
                        <div style="margin-bottom:10px;">${tagsHtml}</div>
                        <h1>${ricetta.titolo}</h1>
                        
                        <p style="color:#666; margin-bottom: 20px; font-size: 0.95rem;">
                            <strong>‚è± Tempo:</strong> ${ricetta.tempo} &nbsp;|&nbsp; 
                            <strong>üë• Porzioni:</strong> ${porzioni} &nbsp;|&nbsp; 
                            <strong>üî• Difficolt√†:</strong> ${ricetta.difficolta}
                        </p>
                        
                        <img src="${ricetta.img}" style="width:100%; max-height:500px; object-fit:cover; border-radius: 12px; margin-bottom: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        
                        <div class="ingredients" style="background:#fff8e1; padding:30px; border-radius:12px; margin-bottom:40px;">
                            <h2 style="margin-top:0; color:#c62828;">Ingredienti</h2>
                            <ul style="margin:0; padding-left:20px;">${listaIngredienti}</ul>
                        </div>

                        <div class="instructions">
                            <h2>Procedimento</h2>
                            <ol style="padding-left:20px; font-size:1.1rem;">${listaPassaggi}</ol>
                        </div>

                        ${videoPrincipaleHtml}
                    `;
                } else {
                    document.getElementById('contenuto-ricetta').innerHTML = `
                        <div style="text-align:center; padding:50px;">
                            <h2>Ops! Ricetta non trovata.</h2>
                            <a href="index.html" class="button" style="max-width:200px; margin:20px auto;">Torna alla Home</a>
                        </div>
                    `;
                }
            });

        // --- FUNZIONE GENERATORE VIDEO ---
        // isStep = true (video piccolo per i passaggi)
        // isStep = false (video grande per la fine)
        function generaHtmlVideo(urlVideo, isStep) {
            const videoId = estraiIdYouTube(urlVideo);
            
            // Stile CSS inline per differenziare i video
            const styleContainer = isStep 
                ? "margin-top:10px; margin-bottom:20px; width:100%; max-width:400px;" // Piccolo
                : "margin-top:10px; margin-bottom:20px;"; // Grande (Responsive pieno)

            if (videoId) {
                // YOUTUBE
                if (isStep) {
                     // Iframe semplice per step
                    return `<div style="${styleContainer} height:250px;"><iframe src="https://www.youtube.com/embed/${videoId}" style="width:100%; height:100%; border-radius:8px;" allowfullscreen></iframe></div>`;
                } else {
                    // Iframe responsive cinematografico per fine pagina
                    return `
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                    </div>`;
                }
            } else {
                // VIDEO LOCALE
                return `
                    <video controls class="local-video-player" style="${styleContainer} border-radius:8px;">
                        <source src="${urlVideo}" type="video/mp4">
                        Il tuo browser non supporta il video.
                    </video>`;
            }
        }

        function estraiIdYouTube(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
    </script>
</body>
</html>